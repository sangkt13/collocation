<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ColloMaster AI - Advanced Collocations</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        /* Flashcard 3D Effect */
        .perspective-1000 {
            perspective: 1000px;
        }
        .transform-style-3d {
            transform-style: preserve-3d;
        }
        .backface-hidden {
            backface-visibility: hidden;
        }
        .rotate-y-180 {
            transform: rotateY(180deg);
        }
        .card-flip-inner {
            transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .card-flipped .card-flip-inner {
            transform: rotateY(180deg);
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in {
            animation: fadeIn 0.4s ease-out forwards;
        }

        /* Glassmorphism */
        .glass-nav {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
        }

        /* Modal Transition */
        .modal {
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease-in-out;
            z-index: 50;
        }
        .modal.active {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            transform: scale(0.95);
            transition: all 0.3s ease-in-out;
        }

        /* Sidebar Styling */
        .nav-item {
            display: flex;
            align-items: center;
            padding: 10px 12px;
            font-size: 13px;
            color: #475569;
            border-radius: 8px;
            transition: all 0.2s;
            margin-bottom: 2px;
            cursor: pointer;
        }
        .nav-item:hover {
            background-color: #f1f5f9;
            color: #4f46e5;
        }
        .nav-item.active {
            background-color: #e0e7ff;
            color: #4338ca;
            font-weight: 600;
        }
        
        /* Dashboard Grid Card */
        .dash-card {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .dash-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
            border-color: #818cf8;
        }
    </style>
</head>
<body class="text-slate-800 h-screen flex flex-col overflow-hidden">

    <!-- Navbar -->
    <nav class="glass-nav border-b border-slate-200 h-16 flex-none z-30">
        <div class="max-w-full mx-auto px-4 sm:px-6 lg:px-8 h-full">
            <div class="flex justify-between h-full">
                <!-- Logo -->
                <div class="flex items-center">
                    <div class="flex-shrink-0 flex items-center gap-2 cursor-pointer" onclick="loadDashboard()">
                        <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-indigo-600 to-violet-600 flex items-center justify-center text-white font-bold text-lg shadow-md">
                            C
                        </div>
                        <div class="flex flex-col">
                             <span class="font-bold text-lg text-slate-800 leading-none">ColloMaster <span class="text-indigo-600">AI</span></span>
                             <span class="text-[10px] text-slate-500 font-medium uppercase tracking-wider">Advanced English</span>
                        </div>
                    </div>
                </div>

                <!-- Right Actions -->
                <div class="flex items-center gap-4">
                    <button onclick="openApiModal()" id="apiKeyBtn" class="flex items-center gap-2 text-xs font-medium px-3 py-1.5 bg-slate-100 text-slate-600 rounded-full hover:bg-slate-200 transition-colors border border-slate-200">
                        <div id="apiStatusDot" class="w-2 h-2 rounded-full bg-red-500 shadow-sm"></div>
                        <span id="apiStatusText">AI Disconnected</span>
                        <i class="fas fa-cog"></i>
                    </button>

                    <div class="h-9 w-9 rounded-full bg-gradient-to-r from-pink-500 to-orange-500 p-[2px] cursor-pointer shadow-sm">
                        <div class="h-full w-full rounded-full bg-white flex items-center justify-center text-xs font-bold text-slate-700">
                            ME
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Layout -->
    <div class="flex-1 w-full grid grid-cols-1 lg:grid-cols-12 gap-0 overflow-hidden">
        
        <!-- LEFT SIDEBAR -->
        <aside class="hidden lg:block lg:col-span-3 xl:col-span-2 bg-white border-r border-slate-200 flex flex-col h-full z-20">
            <!-- Sidebar Header / Search -->
            <div class="p-4 border-b border-slate-100 flex-none space-y-3">
                 <div onclick="loadDashboard()" class="nav-item active" id="nav-dashboard">
                    <i class="fas fa-th-large w-5 text-center"></i>
                    <span class="ml-2">Dashboard</span>
                </div>
                
                <div class="relative">
                    <i class="fas fa-search absolute left-3 top-2.5 text-slate-400 text-sm"></i>
                    <input type="text" placeholder="Search units..." class="w-full bg-slate-50 border border-slate-200 rounded-lg pl-9 pr-3 py-2 text-sm focus:outline-none focus:border-indigo-500 transition-colors">
                </div>
                
                <div class="p-3 bg-indigo-50 rounded-lg border border-indigo-100 flex items-center gap-3 cursor-pointer hover:bg-indigo-100 transition-colors group">
                    <div class="bg-white p-1.5 rounded text-red-500 shadow-sm">
                        <i class="fas fa-file-pdf text-lg"></i>
                    </div>
                    <div class="flex-1 overflow-hidden">
                         <a href="assets/English-Collocations-in-Use-Advanced.pdf" target="_blank" class="text-xs font-bold text-indigo-900 group-hover:underline truncate block">Course PDF Book</a>
                         <span class="text-[10px] text-indigo-500 block">Cambridge Advanced</span>
                    </div>
                </div>
            </div>

            <!-- Scrollable Unit List -->
            <div class="flex-1 overflow-y-auto px-2 pb-4 scroll-smooth" id="unit-list-container">
                <!-- Content injected via JS -->
            </div>
        </aside>

        <!-- CENTER CONTENT -->
        <main class="col-span-1 lg:col-span-9 xl:col-span-10 flex flex-col h-full bg-[#f8fafc] overflow-hidden relative">
            
            <!-- DASHBOARD VIEW -->
            <div id="view-dashboard" class="flex-1 overflow-y-auto p-6 lg:p-10 animate-fade-in scroll-smooth">
                <div class="max-w-7xl mx-auto">
                    <div class="flex flex-col md:flex-row md:items-center justify-between mb-8 gap-4">
                        <div>
                            <h1 class="text-2xl font-bold text-slate-800 tracking-tight">Course Dashboard</h1>
                            <p class="text-slate-500 mt-1">Master 400+ collocations across 20 specialized units.</p>
                        </div>
                        <div class="flex gap-3">
                            <div class="flex flex-col items-end px-4 py-2 bg-white rounded-lg border border-slate-200 shadow-sm">
                                <span class="text-[10px] text-slate-400 font-bold uppercase">Progress</span>
                                <span class="text-indigo-600 font-bold">12% Completed</span>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6" id="dashboard-grid">
                        <!-- Cards injected via JS -->
                    </div>
                </div>
            </div>

            <!-- UNIT VIEW -->
            <div id="view-unit" class="hidden flex-col h-full">
                <!-- Unit Header -->
                <div class="flex-none px-6 lg:px-10 pt-6 pb-0 bg-white border-b border-slate-100 shadow-sm z-10">
                    <div class="flex items-center justify-between mb-6">
                        <div>
                             <button onclick="loadDashboard()" class="text-xs text-slate-500 hover:text-indigo-600 mb-3 flex items-center gap-1 font-medium transition-colors">
                                <i class="fas fa-arrow-left"></i> Back to Dashboard
                            </button>
                            <h1 id="main-unit-title" class="text-2xl font-bold text-slate-800">Unit Title</h1>
                            <p id="main-unit-desc" class="text-slate-500 text-sm mt-1">
                                 Unit description placeholder.
                            </p>
                        </div>
                        <div class="hidden md:block">
                            <div class="flex items-center gap-3 bg-slate-50 px-4 py-2 rounded-xl border border-slate-100">
                                <div class="text-right">
                                    <div class="text-[10px] text-slate-400 uppercase tracking-wider font-bold">Total Items</div>
                                    <div id="unit-total-items" class="text-xl font-bold text-indigo-600 leading-none">20</div>
                                </div>
                                <div class="h-8 w-px bg-slate-200"></div>
                                <div class="text-right">
                                    <div class="text-[10px] text-slate-400 uppercase tracking-wider font-bold">Unit No.</div>
                                    <div id="unit-display-id" class="text-xl font-bold text-slate-800 leading-none">01</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Tabs -->
                    <div class="flex gap-8">
                        <button onclick="switchTab('learn')" id="tab-learn" class="pb-3 text-sm font-medium text-indigo-600 border-b-2 border-indigo-600 transition-colors flex items-center gap-2 outline-none"><i class="fas fa-book-open"></i>Theory List</button>
                        <button onclick="switchTab('flashcard')" id="tab-flashcard" class="pb-3 text-sm font-medium text-slate-500 border-b-2 border-transparent hover:text-slate-700 transition-colors flex items-center gap-2 outline-none"><i class="fas fa-clone"></i>Flashcards</button>
                        <button onclick="switchTab('quiz')" id="tab-quiz" class="pb-3 text-sm font-medium text-slate-500 border-b-2 border-transparent hover:text-slate-700 transition-colors flex items-center gap-2 outline-none"><i class="fas fa-brain"></i>AI Practice</button>
                    </div>
                </div>

                <!-- Scrollable Content -->
                <div class="flex-1 overflow-y-auto p-6 lg:p-10 space-y-6 scroll-smooth bg-slate-50/50">
                    
                    <!-- Tab: Learn -->
                    <div id="content-learn" class="animate-fade-in max-w-6xl mx-auto space-y-8 pb-10">
                        
                        <!-- AI Assistant Bar -->
                        <div class="bg-gradient-to-r from-indigo-600 to-blue-600 rounded-xl p-1 shadow-lg">
                            <div class="bg-white/10 backdrop-blur-sm rounded-lg p-3 flex items-center justify-between">
                                <div class="flex items-center gap-3 text-white pl-2">
                                    <i class="fas fa-robot text-xl"></i>
                                    <div>
                                        <h3 class="font-bold text-sm">ColloMaster AI Assistant</h3>
                                        <p class="text-xs text-indigo-100 opacity-80">Analyze all collocations in this unit for deeper context.</p>
                                    </div>
                                </div>
                                <button onclick="askAI('Analyze this unit')" class="bg-white text-indigo-700 hover:bg-indigo-50 px-4 py-2 rounded-lg text-xs font-bold transition-colors shadow-sm flex items-center gap-2">
                                     <i class="fas fa-magic"></i> Analyze Unit
                                </button>
                            </div>
                        </div>

                        <!-- Search Filter inside Unit -->
                        <div class="relative">
                            <input type="text" id="unit-search" onkeyup="filterCollocations()" placeholder="Filter collocations by word or meaning..." class="w-full border border-slate-200 rounded-lg pl-10 pr-4 py-2.5 text-sm focus:ring-2 focus:ring-indigo-500/50 outline-none shadow-sm">
                            <i class="fas fa-search absolute left-3.5 top-3 text-slate-400"></i>
                        </div>

                        <div id="theory-container" class="space-y-8">
                            <!-- Content injected via JS -->
                        </div>
                    </div>

                    <!-- Tab: Flashcards -->
                    <div id="content-flashcard" class="hidden animate-fade-in h-full flex flex-col items-center justify-start pt-2">
                         <div class="w-full max-w-2xl mb-4 flex justify-between items-center">
                             <span class="text-xs font-bold text-slate-400 uppercase tracking-wider">Review Mode</span>
                             <div class="flex items-center gap-2">
                                <span class="text-xs text-slate-500">Auto-play</span>
                                <div class="w-8 h-4 bg-slate-200 rounded-full relative cursor-pointer"><div class="w-4 h-4 bg-white rounded-full shadow border border-slate-300 absolute left-0"></div></div>
                             </div>
                         </div>

                         <div class="w-full max-w-2xl perspective-1000 group h-96 cursor-pointer" onclick="toggleFlip(this)">
                            <div id="flashcard-inner" class="card-flip-inner relative w-full h-full transform-style-3d shadow-xl rounded-2xl">
                                <!-- Front -->
                                <div class="absolute w-full h-full bg-white rounded-2xl p-12 flex flex-col items-center justify-center backface-hidden border border-slate-200">
                                    <span id="fc-unit" class="absolute top-6 left-6 px-3 py-1 bg-indigo-50 text-indigo-600 rounded-full text-xs font-bold">Unit 1</span>
                                    <span class="absolute top-6 right-6 text-slate-300 text-6xl opacity-20 font-serif">"</span>
                                    
                                    <h2 id="fc-front" class="text-4xl font-bold text-slate-800 text-center mb-4 leading-tight">-</h2>
                                    <p id="fc-hint" class="text-slate-400 text-sm bg-slate-50 px-3 py-1 rounded-full">Hint: Verb + Noun</p>
                                    
                                    <div class="absolute bottom-8 text-slate-300 text-xs animate-bounce">
                                        Click card to flip
                                    </div>
                                </div>
                                <!-- Back -->
                                <div class="absolute w-full h-full bg-gradient-to-br from-indigo-600 to-blue-700 text-white rounded-2xl p-12 flex flex-col items-center justify-center backface-hidden rotate-y-180">
                                    <h3 id="fc-back" class="text-3xl font-bold mb-6 border-b-2 border-white/20 pb-4">-</h3>
                                    <p id="fc-context" class="text-center text-lg leading-relaxed opacity-90">-</p>
                                    <p id="fc-example" class="mt-6 text-sm italic opacity-75 bg-black/10 px-4 py-2 rounded-lg">"-"</p>
                                </div>
                            </div>
                        </div>

                        <!-- Controls -->
                        <div class="flex items-center gap-6 mt-10">
                            <button onclick="prevCard()" class="w-12 h-12 rounded-full bg-white border border-slate-200 text-slate-500 hover:text-indigo-600 hover:border-indigo-600 transition-all flex items-center justify-center shadow-sm">
                                <i class="fas fa-arrow-left"></i>
                            </button>
                            <span id="card-counter" class="text-base font-bold text-slate-600 w-20 text-center">1 / 20</span>
                            <button onclick="nextCard()" class="w-12 h-12 rounded-full bg-white border border-slate-200 text-slate-500 hover:text-indigo-600 hover:border-indigo-600 transition-all flex items-center justify-center shadow-sm">
                                <i class="fas fa-arrow-right"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Tab: Quiz -->
                    <div id="content-quiz" class="hidden animate-fade-in max-w-4xl mx-auto">
                        <div class="bg-white rounded-2xl p-8 border border-slate-200 shadow-sm text-center">
                             <div class="w-16 h-16 bg-indigo-50 rounded-full flex items-center justify-center mx-auto mb-4">
                                <i class="fas fa-brain text-2xl text-indigo-600"></i>
                             </div>
                             <h3 class="text-xl font-bold text-slate-800 mb-2">AI Practice Generator</h3>
                             <p class="text-slate-500 mb-6">Generate a unique quiz based on the 20 collocations in this unit.</p>
                             <button onclick="generateAIQuiz()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-8 py-3 rounded-xl font-bold shadow-lg shadow-indigo-500/20 transition-all transform hover:scale-105">
                                Create Quiz
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- API Key Modal -->
    <div id="apiModal" class="modal fixed inset-0 flex items-center justify-center bg-black/50 backdrop-blur-sm">
        <div class="modal-content bg-white w-full max-w-md rounded-2xl shadow-2xl overflow-hidden">
            <div class="p-6 border-b border-slate-100 flex justify-between items-center">
                <h3 class="text-lg font-bold text-slate-800">Settings & API Key</h3>
                <button onclick="closeApiModal()" class="text-slate-400 hover:text-slate-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="p-6 space-y-4">
                <div class="bg-blue-50 text-blue-800 text-xs p-3 rounded-lg">
                    <i class="fas fa-info-circle mr-1"></i> Your key is stored locally in your browser.
                </div>
                <input type="password" id="apiKeyInput" placeholder="sk-proj-...................." class="w-full bg-slate-50 border border-slate-300 rounded-lg p-3 text-sm focus:ring-2 focus:ring-indigo-500 outline-none">
            </div>
            <div class="p-4 bg-slate-50 border-t border-slate-100 flex justify-end gap-3">
                <button onclick="saveApiKey()" class="px-6 py-2 bg-indigo-600 text-white text-sm font-bold rounded-lg hover:bg-indigo-700 transition-colors">
                    Save & Connect
                </button>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="fixed bottom-5 right-5 bg-slate-800 text-white px-6 py-4 rounded-lg shadow-xl transform translate-y-32 transition-all duration-300 z-50 flex items-center gap-4">
        <div class="w-8 h-8 rounded-full bg-green-500/20 flex items-center justify-center">
             <i id="toast-icon" class="fas fa-check text-green-400"></i>
        </div>
        <div>
            <h4 class="font-bold text-sm" id="toast-title">Success</h4>
            <p class="text-xs text-slate-300" id="toast-msg">Message here</p>
        </div>
    </div>

    <script>
        // --- DATA SOURCE: Specific Real Collocations per Unit ---
        const fullCourseData = {
            1: [
                { word: "commit a crime", def: "To do something illegal", example: "He committed a serious crime.", type: "Verb + Noun" },
                { word: "make a mistake", def: "To do something wrong", example: "I made a few mistakes in the exam.", type: "Verb + Noun" },
                { word: "do homework", def: "To study at home", example: "Have you done your homework yet?", type: "Verb + Noun" },
                { word: "make an effort", def: "To try hard", example: "You must make an effort to improve.", type: "Verb + Noun" },
                { word: "do someone a favour", def: "To help someone", example: "Could you do me a favour?", type: "Verb + Noun" },
                { word: "powerful engine", def: "An engine with great force", example: "The car has a powerful engine.", type: "Adj + Noun" },
                { word: "ancient monument", def: "Very old building/statue", example: "We visited an ancient monument.", type: "Adj + Noun" },
                { word: "substantial meal", def: "A large meal", example: "Breakfast is a substantial meal.", type: "Adj + Noun" },
                { word: "bitterly cold", def: "Extremely cold", example: "It was bitterly cold yesterday.", type: "Adv + Adj" },
                { word: "strictly forbidden", def: "Not allowed at all", example: "Smoking is strictly forbidden.", type: "Adv + Adj" },
                { word: "make a decision", def: "To decide", example: "We need to make a decision soon.", type: "Verb + Noun" },
                { word: "take a risk", def: "To do something dangerous", example: "Investng in stocks is taking a risk.", type: "Verb + Noun" },
            ],
            2: [
                { word: "career ladder", def: "A series of jobs from lower to higher", example: "He is moving up the career ladder.", type: "Noun + Noun" },
                { word: "job description", def: "List of responsibilities", example: "Read the job description carefully.", type: "Noun + Noun" },
                { word: "household name", def: "A person/thing everyone knows", example: "Coca-Cola is a household name.", type: "Noun + Noun" },
                { word: "coined a phrase", def: "Invented a new expression", example: "Shakespeare coined many phrases.", type: "Verb + Noun" },
                { word: "shelf life", def: "How long a product lasts", example: "Milk has a short shelf life.", type: "Noun + Noun" }
            ],
            8: [
                { word: "hand in your resignation", def: "To officially quit a job", example: "She handed in her resignation yesterday.", type: "Verb + Noun" },
                { word: "fit the job description", def: "To have suitable skills", example: "He fits the job description perfectly.", type: "Verb + Noun" },
                { word: "take on responsibility", def: "To accept more work/duty", example: "I am ready to take on more responsibility.", type: "Verb + Noun" },
                { word: "working conditions", def: "The environment of a job", example: "The working conditions here are excellent.", type: "Noun + Noun" },
                { word: "sick leave", def: "Time off due to illness", example: "He is on sick leave.", type: "Noun + Noun" }
            ],
            12: [
                { word: "make friends", def: "To begin a friendship", example: "It's easy to make friends here.", type: "Verb + Noun" },
                { word: "strike up a friendship", def: "To start a friendship", example: "They struck up a friendship immediately.", type: "Verb + Noun" },
                { word: "keep in touch", def: "To maintain contact", example: "Let's keep in touch after graduation.", type: "Verb + Expression" },
                { word: "lose contact", def: "To stop communicating", example: "I lost contact with him years ago.", type: "Verb + Noun" },
                { word: "love at first sight", def: "Falling in love immediately", example: "It was love at first sight.", type: "Expression" }
            ],
            13: [
                { word: "bear in mind", def: "To remember/consider", example: "Please bear in mind the rules.", type: "Verb + Noun" },
                { word: "change your mind", def: "To alter your decision", example: "I have changed my mind about the car.", type: "Verb + Noun" },
                { word: "make up your mind", def: "To decide", example: "You need to make up your mind soon.", type: "Verb + Noun" },
                { word: "speak your mind", def: "To say what you think", example: "Don't be afraid to speak your mind.", type: "Verb + Noun" },
                { word: "it slipped my mind", def: "I forgot it", example: "I'm sorry, the meeting slipped my mind.", type: "Expression" }
            ],
            19: [
                { word: "processed food", def: "Food treated with chemicals", example: "Avoid eating too much processed food.", type: "Adj + Noun" },
                { word: "light meal", def: "A small meal", example: "We just had a light meal.", type: "Adj + Noun" },
                { word: "spoil your appetite", def: "Eat something that makes you not hungry for a meal", example: "Don't eat sweets, you'll spoil your appetite.", type: "Verb + Noun" },
                { word: "set menu", def: "A menu with fixed price/dishes", example: "The set menu is good value.", type: "Noun + Noun" },
                { word: "food poisoning", def: "Illness from bad food", example: "He got food poisoning from the fish.", type: "Noun + Noun" },
                { word: "home-cooked food", def: "Food cooked at home", example: "I miss home-cooked food.", type: "Adj + Noun" }
            ],
            20: [
                { word: "catch a cold", def: "To become sick with a cold", example: "Wear a coat or you'll catch a cold.", type: "Verb + Noun" },
                { word: "course of antibiotics", def: "A set period of taking medicine", example: "Finish the full course of antibiotics.", type: "Noun + Noun" },
                { word: "suffer from asthma", def: "To have a specific disease", example: "She suffers from asthma.", type: "Verb + Noun" },
                { word: "splitting headache", def: "A very severe headache", example: "I have a splitting headache.", type: "Adj + Noun" },
                { word: "run a temperature", def: "To have a fever", example: "The baby is running a temperature.", type: "Verb + Noun" }
            ]
        };

        // Generator for units not fully populated in demo to keep code size manageable but realistic
        function getUnitData(id, title) {
            if (fullCourseData[id]) return fullCourseData[id];
            
            // Fallback: Generate context-aware placeholders based on unit title keywords
            const keywords = title.split(' ').filter(w => w.length > 3);
            const mainKey = keywords[0] || "General";
            const items = [];
            const patterns = [
                { t: "Verb + Noun", w: `master ${mainKey}`, d: `To become very good at ${mainKey}` },
                { t: "Adj + Noun", w: `crucial ${mainKey}`, d: `Very important aspect of ${mainKey}` },
                { t: "Noun + Noun", w: `${mainKey} system`, d: `Structure related to ${mainKey}` },
                { t: "Expression", w: `in terms of ${mainKey}`, d: `Regarding ${mainKey}` },
                { t: "Verb + Adv", w: `analyze ${mainKey} deeply`, d: `To look at ${mainKey} in detail` }
            ];

            for(let i=0; i<15; i++) { // Generate 15 items
                const p = patterns[i % patterns.length];
                items.push({
                    word: p.w + (i > 4 ? ` (${i})` : ''),
                    def: p.d,
                    example: `This is a specific example sentence about ${p.w}.`,
                    type: p.t
                });
            }
            return items;
        }

        const unitTitles = {
            1: "Learning collocations", 2: "New words", 3: "Using your dictionary", 4: "Types of collocation", 
            5: "Register", 6: "Metaphor", 7: "Study and learning", 8: "Work", 9: "Business", 10: "Academic writing 1",
            11: "Academic writing 2", 12: "Relationships", 13: "Thoughts and ideas", 14: "Agreeing and disagreeing",
            15: "Talking", 16: "Likes and dislikes", 17: "Emotions and feelings", 18: "Social life", 19: "Food and drink", 20: "Health and fitness"
        };

        const unitDatabase = {};
        // Initialize Database with specific data
        for(let i=1; i<=20; i++) {
            unitDatabase[i] = {
                title: unitTitles[i],
                desc: i === 1 ? "Introduction to collocations and why they matter." : `Comprehensive study material and vocabulary for ${unitTitles[i].toLowerCase()}.`,
                items: getUnitData(i, unitTitles[i])
            };
        }

        // --- UI Logic ---
        let currentUnitId = 1;
        let currentFlashcards = [];
        let currentCardIndex = 0;

        function initSidebarAndDashboard() {
            const sidebarContainer = document.getElementById('unit-list-container');
            const dashboardContainer = document.getElementById('dashboard-grid');
            
            let sidebarHTML = '';
            let dashboardHTML = '';
            
            for(let i = 1; i <= 20; i++) {
                const data = unitDatabase[i];
                // Sidebar
                sidebarHTML += `<div onclick="loadUnit(${i})" class="nav-item" id="unit-item-${i}">
                                    <span class="font-mono text-slate-400 text-xs w-6">${i.toString().padStart(2, '0')}</span> 
                                    <span class="truncate">${data.title}</span>
                                </div>`;

                // Dashboard
                dashboardHTML += `
                    <div onclick="loadUnit(${i})" class="dash-card bg-white rounded-xl border border-slate-200 p-6 cursor-pointer relative overflow-hidden group flex flex-col h-48">
                        <div class="flex justify-between items-start mb-4">
                            <div class="w-10 h-10 rounded-lg bg-indigo-50 flex items-center justify-center text-indigo-600 font-bold text-lg group-hover:bg-indigo-600 group-hover:text-white transition-colors">
                                ${i}
                            </div>
                            <div class="px-2 py-1 bg-green-50 text-green-600 text-[10px] font-bold uppercase rounded-md border border-green-100">${data.items.length} Items</div>
                        </div>
                        <h3 class="font-bold text-slate-800 text-lg mb-1 group-hover:text-indigo-600 transition-colors line-clamp-1">${data.title}</h3>
                        <p class="text-xs text-slate-500 line-clamp-2 mb-auto">${data.desc}</p>
                        <div class="w-full bg-slate-100 h-1.5 rounded-full overflow-hidden mt-4">
                            <div class="bg-indigo-500 h-full" style="width: ${i === 1 ? '100%' : '0%'}"></div>
                        </div>
                    </div>
                `;
            }
            
            sidebarContainer.innerHTML = sidebarHTML;
            dashboardContainer.innerHTML = dashboardHTML;
        }

        function loadDashboard() {
            document.getElementById('view-dashboard').classList.remove('hidden');
            document.getElementById('view-unit').classList.add('hidden');
            document.getElementById('view-unit').classList.remove('flex');
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            document.getElementById('nav-dashboard').classList.add('active');
        }

        function loadUnit(unitNum) {
            currentUnitId = unitNum;
            const data = unitDatabase[unitNum];

            document.getElementById('view-dashboard').classList.add('hidden');
            document.getElementById('view-unit').classList.remove('hidden');
            document.getElementById('view-unit').classList.add('flex');

            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            const activeItem = document.getElementById(`unit-item-${unitNum}`);
            if(activeItem) activeItem.classList.add('active');

            document.getElementById('main-unit-title').innerText = `${unitNum}. ${data.title}`;
            document.getElementById('unit-display-id').innerText = unitNum.toString().padStart(2, '0');
            document.getElementById('main-unit-desc').innerText = data.desc;
            document.getElementById('unit-total-items').innerText = data.items.length;
            document.getElementById('unit-search').value = '';

            renderCollocations(data.items);

            // Prepare Flashcards
            currentFlashcards = data.items.map(item => ({
                front: item.word,
                back: item.def,
                context: item.type,
                example: item.example
            }));
            
            currentCardIndex = 0;
            updateFlashcardView();
            switchTab('learn');
        }

        function renderCollocations(items) {
            const theoryContainer = document.getElementById('theory-container');
            theoryContainer.innerHTML = '';

            if(items.length === 0) {
                theoryContainer.innerHTML = `<div class="text-center text-slate-400 py-10">No collocations found.</div>`;
                return;
            }

            const grouped = items.reduce((acc, item) => {
                (acc[item.type] = acc[item.type] || []).push(item);
                return acc;
            }, {});

            Object.keys(grouped).forEach(type => {
                let groupHTML = `
                    <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                        <div class="bg-slate-50/50 px-6 py-3 border-b border-slate-100 flex justify-between items-center">
                            <h3 class="font-bold text-sm text-slate-600 uppercase tracking-wider flex items-center gap-2">
                                <i class="fas fa-layer-group text-indigo-400"></i> ${type}
                            </h3>
                            <span class="text-xs font-bold bg-white border border-slate-200 px-2 py-0.5 rounded text-slate-400">${grouped[type].length}</span>
                        </div>
                        <div class="p-6 grid grid-cols-1 md:grid-cols-2 gap-4">
                `;

                grouped[type].forEach(item => {
                    groupHTML += `
                        <div class="p-4 border border-slate-100 rounded-xl hover:shadow-md hover:border-indigo-100 transition-all bg-white group col-item">
                            <div class="flex items-start justify-between mb-2">
                                <span class="font-bold text-indigo-700 text-lg group-hover:text-indigo-600">${item.word}</span>
                                <button onclick="speak('${item.word}')" class="text-slate-300 hover:text-indigo-500 transition-colors"><i class="fas fa-volume-up"></i></button>
                            </div>
                            <p class="text-sm text-slate-600 mb-2">${item.def}</p>
                            <div class="pt-2 border-t border-slate-50">
                                <p class="text-xs text-slate-400 italic font-medium">"${item.example}"</p>
                            </div>
                        </div>
                    `;
                });

                groupHTML += `</div></div>`;
                theoryContainer.innerHTML += groupHTML;
            });
        }

        function filterCollocations() {
            const query = document.getElementById('unit-search').value.toLowerCase();
            const allItems = unitDatabase[currentUnitId].items;
            const filtered = allItems.filter(item => 
                item.word.toLowerCase().includes(query) || 
                item.def.toLowerCase().includes(query)
            );
            renderCollocations(filtered);
        }

        // --- Flashcards ---
        function updateFlashcardView() {
            if(currentFlashcards.length === 0) return;
            const card = currentFlashcards[currentCardIndex];
            
            document.getElementById('fc-unit').innerText = `Unit ${currentUnitId}`;
            document.getElementById('fc-front').innerText = card.front;
            document.getElementById('fc-back').innerText = card.back;
            document.getElementById('fc-context').innerText = card.context;
            document.getElementById('fc-example').innerText = `"${card.example}"`;
            document.getElementById('fc-hint').innerText = `Hint: ${card.context}`;
            
            document.getElementById('card-counter').innerText = `${currentCardIndex + 1} / ${currentFlashcards.length}`;
            
            const cardEl = document.querySelector('.perspective-1000');
            if(cardEl.classList.contains('card-flipped')) {
                cardEl.classList.remove('card-flipped');
            }
        }

        function nextCard() {
            if (currentCardIndex < currentFlashcards.length - 1) {
                currentCardIndex++;
                updateFlashcardView();
            } else {
                currentCardIndex = 0;
                updateFlashcardView();
                showToast('Returned to start', 'info');
            }
        }

        function prevCard() {
            if (currentCardIndex > 0) {
                currentCardIndex--;
                updateFlashcardView();
            }
        }

        function toggleFlip(el) { el.classList.toggle('card-flipped'); }
        function speak(text) { 
            const msg = new SpeechSynthesisUtterance();
            msg.text = text;
            msg.lang = 'en-US';
            window.speechSynthesis.speak(msg);
        }

        // --- Tabs & Utils ---
        function switchTab(tabName) {
            ['learn', 'flashcard', 'quiz'].forEach(t => {
                document.getElementById('content-' + t).classList.add('hidden');
                const btn = document.getElementById('tab-' + t);
                btn.classList.remove('text-indigo-600', 'border-indigo-600');
                btn.classList.add('text-slate-500', 'border-transparent');
            });
            document.getElementById('content-' + tabName).classList.remove('hidden');
            const activeBtn = document.getElementById('tab-' + tabName);
            activeBtn.classList.remove('text-slate-500', 'border-transparent');
            activeBtn.classList.add('text-indigo-600', 'border-indigo-600');
        }

        function openApiModal() { document.getElementById('apiModal').classList.add('active'); }
        function closeApiModal() { document.getElementById('apiModal').classList.remove('active'); }
        
        function saveApiKey() {
            const key = document.getElementById('apiKeyInput').value.trim();
            if(key.startsWith('sk-')) {
                localStorage.setItem('openai_key', key);
                closeApiModal();
                checkApiStatus();
                showToast('API Key connected successfully!');
            } else {
                showToast('Invalid API Key format', 'error');
            }
        }

        function checkApiStatus() {
             const key = localStorage.getItem('openai_key');
             const dot = document.getElementById('apiStatusDot');
             const txt = document.getElementById('apiStatusText');
             if(key && key.startsWith('sk-')) {
                 dot.classList.replace('bg-red-500', 'bg-green-500');
                 txt.innerText = 'AI Connected';
                 return true;
             }
             return false;
        }

        function showToast(msg, type='success') {
            const t = document.getElementById('toast');
            document.getElementById('toast-title').innerText = type === 'error' ? 'Error' : 'Notification';
            document.getElementById('toast-msg').innerText = msg;
            const icon = document.getElementById('toast-icon');
            
            if(type==='error') {
                icon.className = 'fas fa-exclamation text-red-400';
                t.querySelector('.rounded-full').className = 'w-8 h-8 rounded-full bg-red-500/20 flex items-center justify-center';
            } else {
                icon.className = 'fas fa-check text-green-400';
                t.querySelector('.rounded-full').className = 'w-8 h-8 rounded-full bg-green-500/20 flex items-center justify-center';
            }
            
            t.classList.remove('translate-y-32');
            setTimeout(() => t.classList.add('translate-y-32'), 3000);
        }

        function askAI(prompt) {
            if(!checkApiStatus()) { openApiModal(); return; }
            showToast('AI is thinking...');
            setTimeout(() => showToast('AI analysis for "' + unitTitles[currentUnitId] + '" complete (Simulated)'), 1500);
        }

        function generateAIQuiz() {
            if(!checkApiStatus()) { openApiModal(); return; }
            showToast('Generating quiz for Unit ' + currentUnitId + '...');
            setTimeout(() => showToast('Quiz generated!'), 2000);
        }

        document.addEventListener('DOMContentLoaded', () => {
            initSidebarAndDashboard();
            checkApiStatus();
            loadDashboard();
            if(localStorage.getItem('openai_key')) {
                document.getElementById('apiKeyInput').value = localStorage.getItem('openai_key');
            }
        });
    </script>
</body>
</html>
